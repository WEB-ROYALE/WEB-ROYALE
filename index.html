<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Clash Web: Progress Update</title>
    <style>
        body {
            margin: 0; background: #121212; overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
            display: flex; justify-content: center; height: 100vh;
            user-select: none; -webkit-user-select: none;
        }

        #game-wrapper {
            width: 100%; max-width: 450px; height: 100%;
            background: #222; position: relative;
            display: flex; flex-direction: column;
            box-shadow: 0 0 30px black; border: 2px solid #444;
            overflow: hidden;
        }

        /* --- PANTALLAS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column;
        }
        .screen.active { display: flex; }

        /* --- MENU PRINCIPAL --- */
        #main-menu {
            background: linear-gradient(135deg, #2c3e50, #4ca1af);
            align-items: center; justify-content: flex-start;
            z-index: 600; padding-top: 20px;
        }

        .top-bar {
            display: flex; gap: 10px; width: 90%; justify-content: space-between;
            margin-bottom: 30px;
        }
        .stat-box {
            background: rgba(0,0,0,0.5); padding: 8px 12px;
            border-radius: 20px; color: white; font-weight: bold;
            display: flex; align-items: center; gap: 5px; border: 1px solid rgba(255,255,255,0.2);
            font-size: 14px;
        }

        #game-logo {
            font-size: 40px; font-weight: 900; color: #f1c40f;
            text-shadow: 0 4px 0 #d35400, 0 8px 10px black;
            margin-bottom: 20px; letter-spacing: 2px;
            text-align: center; line-height: 1;
        }

        /* --- NUEVA BARRA DE PROGRESO --- */
        #arena-info-box {
            width: 80%;
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: flex; flex-direction: column; align-items: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        #current-arena-display {
            color: #fff; font-size: 18px; font-weight: bold;
            margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            text-transform: uppercase; letter-spacing: 1px;
        }
        
        #progress-container {
            width: 100%;
            display: flex; flex-direction: column;
        }
        
        #progress-text {
            color: #ddd; font-size: 12px; margin-bottom: 4px; 
            text-align: right; font-weight: bold;
        }

        #progress-bar-bg {
            width: 100%; height: 12px;
            background: #333;
            border-radius: 6px;
            border: 1px solid #555;
            overflow: hidden;
            position: relative;
        }

        #progress-fill {
            height: 100%; width: 0%;
            background: linear-gradient(90deg, #f1c40f, #f39c12);
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
            transition: width 0.5s ease-out;
        }

        #battle-btn {
            background: #f1c40f; color: #5d4037;
            font-size: 24px; font-weight: 900;
            padding: 20px 60px; border-radius: 10px;
            border: none; border-bottom: 6px solid #d35400;
            cursor: pointer; transition: transform 0.1s;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            text-transform: uppercase;
        }
        #battle-btn:active { transform: translateY(4px); border-bottom-width: 2px; }

        .chest-slots {
            display: flex; gap: 10px; margin-top: auto; margin-bottom: 20px;
        }
        .chest {
            width: 70px; height: 70px; background: rgba(0,0,0,0.3);
            border: 2px dashed rgba(255,255,255,0.2); border-radius: 10px;
            display: flex; justify-content: center; align-items: center;
            color: rgba(255,255,255,0.3); font-size: 10px; text-align: center;
        }

        /* --- ARENA --- */
        #arena {
            flex: 1; position: relative; overflow: hidden;
            background-color: #5ccf3a; 
            background-image: linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            cursor: pointer; transition: background-color 0.5s;
        }

        .red-zone {
            position: absolute; background: rgba(255, 0, 0, 0.35);
            pointer-events: none; display: none; z-index: 5;
            border-bottom: 2px dashed rgba(255,0,0,0.8);
        }

        #toast-msg {
            position: absolute; top: 40%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220, 20, 60, 0.9);
            color: white; padding: 10px 20px;
            border-radius: 25px; font-weight: bold; font-size: 16px;
            pointer-events: none; opacity: 0; transition: opacity 0.3s ease;
            z-index: 200; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            text-align: center; border: 2px solid white;
        }
        #toast-msg.show { opacity: 1; transform: translate(-50%, -60%); }

        /* --- UI IN-GAME --- */
        #arena-name-ingame {
            position: absolute; top: 50px; left: 50%; transform: translateX(-50%);
            color: rgba(255,255,255,0.5); font-weight: bold; font-size: 12px; pointer-events: none;
            text-transform: uppercase; letter-spacing: 1px;
        }

        #timer-display {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.6); color: #fff; font-weight: bold; font-size: 20px;
            padding: 8px 20px; border-radius: 20px; border: 2px solid #f1c40f;
            z-index: 50; pointer-events: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        #next-card-indicator {
            position: absolute; bottom: 170px; right: 10px;
            color: white; font-size: 10px; pointer-events: none; opacity: 0.7;
        }

        .river {
            position: absolute; top: 50%; left: 0; width: 100%; height: 40px;
            background: #4facfe; transform: translateY(-50%);
            border-top: 3px solid #8baebf; border-bottom: 3px solid #8baebf;
            pointer-events: none; z-index: 1;
        }
        .bridge {
            position: absolute; top: 50%; width: 50px; height: 64px;
            background: #8b5a2b; transform: translateY(-50%);
            border-left: 3px solid #5c3a1e; border-right: 3px solid #5c3a1e;
            pointer-events: none; z-index: 2;
            background-image: repeating-linear-gradient(0deg, transparent, transparent 10px, rgba(0,0,0,0.2) 10px);
        }

        /* ENTIDADES & VISUALES */
        .entity {
            position: absolute; transform: translate(-50%, -50%);
            display: flex; flex-direction: column; align-items: center;
            z-index: 10; transition: top 0.1s linear, left 0.1s linear;
        }
        .char-svg { width: 60px; height: 60px; filter: drop-shadow(0 4px 3px rgba(0,0,0,0.5)); }
        .entity:not(.tower):not(.king) .char-svg { animation: bounce 1.5s infinite ease-in-out; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        
        .hp-bar {
            width: 40px; height: 6px; background: #222;
            border-radius: 3px; border: 1px solid #000;
            position: absolute; top: -10px; overflow: hidden;
        }
        .hp-fill { height: 100%; width: 100%; background: #4ade80; transition: width 0.2s; }
        .enemy .hp-fill { background: #ef4444; }

        .projectile {
            position: absolute; width: 10px; height: 10px;
            background: black; border-radius: 50%; z-index: 20; box-shadow: 0 0 2px white;
        }

        .spell-fly {
            position: absolute; width: 30px; height: 30px; z-index: 100;
            transition: all 0.8s ease-in; pointer-events: none;
        }
        .spell-explosion {
            position: absolute; border-radius: 50%; transform: translate(-50%, -50%);
            pointer-events: none; z-index: 90; opacity: 0.8; animation: explode 0.5s forwards;
        }
        @keyframes explode { 0% { opacity: 0.8; transform: translate(-50%, -50%) scale(0.2); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); } }

        /* HUD JUEGO */
        #hud {
            height: 160px; background: #2c3e50; border-top: 4px solid #34495e;
            padding: 10px; display: flex; flex-direction: column; z-index: 100;
        }
        #elixir-display {
            color: #d946ef; font-weight: 900; font-size: 20px;
            margin-bottom: 8px; display: flex; align-items: center;
        }
        #elixir-bar-bg {
            flex: 1; height: 18px; background: #111; margin-left: 10px;
            border-radius: 9px; border: 2px solid #555; position: relative; overflow: hidden;
        }
        #elixir-fill { height: 100%; width: 50%; background: linear-gradient(90deg, #c026d3, #e879f9); transition: width 0.2s; }
        #deck { display: flex; justify-content: center; gap: 8px; height: 100%; }
        
        .card {
            width: 70px; background: #ecf0f1; border-radius: 6px;
            border-bottom: 4px solid #bdc3c7; cursor: pointer;
            position: relative; display: flex; flex-direction: column; align-items: center;
        }
        .card.selected { border-color: #facc15; transform: translateY(-8px); background: #fff; }
        .card.disabled { opacity: 0.5; filter: grayscale(1); }
        .card-cost {
            position: absolute; top: -5px; left: -5px; width: 20px; height: 20px;
            background: #d946ef; color: white; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; font-size: 12px; font-weight: bold; border: 1px solid white;
        }
        .card-icon svg { width: 45px; height: 45px; margin-top: 5px; }
        .card-name { font-size: 9px; font-weight: bold; text-transform: uppercase; margin-top: auto; margin-bottom: 4px; }

        /* PANTALLA FIN DE PARTIDA */
        #end-screen {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); z-index: 800;
            display: none; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        #end-title { font-size: 40px; font-weight: 900; margin-bottom: 10px; }
        #end-trophies { font-size: 24px; color: #f1c40f; margin-bottom: 30px; }
        .btn-menu {
            padding:15px 30px; font-size:18px; background:#3498db; color: white;
            border:none; border-radius: 8px; cursor:pointer; font-weight:bold;
            border-bottom: 4px solid #2980b9;
        }
        .btn-menu:active { transform: translateY(2px); border-bottom-width: 0; }
    </style>
</head>
<body>

<div id="game-wrapper">
    
    <div id="main-menu" class="screen active">
        <div class="top-bar">
            <div class="stat-box">üèÜ <span id="menu-trophies">0</span></div>
            <div class="stat-box">üí∞ <span id="menu-coins">150</span></div>
            <div class="stat-box">üíé <span id="menu-gems">25</span></div>
        </div>

        <div id="game-logo">CLASH<br>WEB</div>
        
        <div id="arena-info-box">
            <div id="current-arena-display">Arena: Entrenamiento</div>
            <div id="progress-container">
                <div id="progress-text">0 / 50</div>
                <div id="progress-bar-bg">
                    <div id="progress-fill"></div>
                </div>
            </div>
        </div>

        <button id="battle-btn" onclick="game.startBattle()">BATALLA</button>

        <div class="chest-slots">
            <div class="chest">Cofre<br>Vac√≠o</div>
            <div class="chest">Cofre<br>Vac√≠o</div>
            <div class="chest">Cofre<br>Vac√≠o</div>
            <div class="chest">Cofre<br>Vac√≠o</div>
        </div>
    </div>

    <div id="game-screen" class="screen">
        <div id="arena" onclick="handleTap(event)">
            <div id="zone-king" class="red-zone" style="top:0; left:0; width:100%; height:160px;"></div>
            <div id="zone-left" class="red-zone" style="top:160px; left:0; width:50%; bottom:50%;"></div>
            <div id="zone-right" class="red-zone" style="top:160px; left:50%; width:50%; bottom:50%;"></div>
            
            <div id="toast-msg">¬°ZONA INV√ÅLIDA!</div>
            <div id="timer-display">03:00</div>
            <div id="arena-name-ingame">Arena 1</div>
            <div id="next-card-indicator">Sig: ???</div>
            
            <div class="river"></div>
            <div class="bridge" style="left: 20%"></div>
            <div class="bridge" style="left: 80%"></div>
        </div>

        <div id="hud">
            <div id="elixir-display">
                <span id="elixir-num">5</span>
                <div id="elixir-bar-bg"><div id="elixir-fill"></div></div>
            </div>
            <div id="deck"></div>
        </div>
    </div>

    <div id="end-screen">
        <h1 id="end-title">FIN</h1>
        <div id="end-trophies">+0 üèÜ</div>
        <button class="btn-menu" onclick="game.returnToMenu()">Volver al Men√∫</button>
    </div>

</div>

<script>
/* ================= CONFIGURACI√ìN DE ARENAS ================= */
const ARENAS = [
    { min: 0,   name: "Entrenamiento", color: "#5ccf3a", difficulty: 0.8 }, 
    { min: 50,  name: "Valle de Huesos", color: "#d35400", difficulty: 1.0 }, 
    { min: 100, name: "Coliseo B√°rbaro", color: "#f39c12", difficulty: 1.1 }, 
    { min: 200, name: "Pico Helado",     color: "#aed6f1", difficulty: 1.25 }, 
    { min: 400, name: "Arena Legendaria",color: "#8e44ad", difficulty: 1.5 } 
];

// --- GESTI√ìN DE DATOS PERSISTENTES (LOCALSTORAGE) ---
const player = {
    trophies: 0, coins: 100, gems: 10,
    
    getArena() {
        return ARENAS.slice().reverse().find(a => this.trophies >= a.min) || ARENAS[0];
    },

    load() {
        const data = localStorage.getItem('clashWebData');
        if(data) {
            const parsed = JSON.parse(data);
            this.trophies = parsed.trophies || 0;
            this.coins = parsed.coins || 100;
            this.gems = parsed.gems || 10;
        }
        this.updateMenuUI();
    },
    save() {
        const data = { trophies: this.trophies, coins: this.coins, gems: this.gems };
        localStorage.setItem('clashWebData', JSON.stringify(data));
        this.updateMenuUI();
    },
    updateMenuUI() {
        document.getElementById('menu-trophies').innerText = this.trophies;
        document.getElementById('menu-coins').innerText = this.coins;
        document.getElementById('menu-gems').innerText = this.gems;
        
        // --- L√ìGICA DE BARRA DE PROGRESO DE ARENA ---
        const currentArena = this.getArena();
        const currentIdx = ARENAS.findIndex(a => a.name === currentArena.name);
        const nextArena = ARENAS[currentIdx + 1];

        const arenaNameEl = document.getElementById('current-arena-display');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        
        arenaNameEl.innerText = "Arena: " + currentArena.name;
        // Cambiar color de la caja de info un poco basado en la arena
        // document.getElementById('arena-info-box').style.borderColor = currentArena.color;

        if (nextArena) {
            // Calcular porcentaje entre la arena actual y la siguiente
            const range = nextArena.min - currentArena.min;
            const currentInArena = this.trophies - currentArena.min;
            let percentage = (currentInArena / range) * 100;
            
            if(percentage > 100) percentage = 100;
            if(percentage < 0) percentage = 0;

            progressFill.style.width = percentage + '%';
            progressText.innerText = `${this.trophies} / ${nextArena.min} üèÜ`;
        } else {
            // Nivel m√°ximo alcanzado
            progressFill.style.width = '100%';
            progressText.innerText = "¬°LIGA M√ÅXIMA!";
        }
    }
};

/* ================= MODELOS SVG Y CARTAS ================= */
const SVGS = {
    knight: (c) => `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="20" fill="#7f8c8d" stroke="black"/><rect x="35" y="45" width="30" height="35" fill="${c}" stroke="black" rx="5"/><rect x="30" y="45" width="40" height="10" fill="#95a5a6" stroke="black"/><circle cx="50" cy="30" r="14" fill="#f1c40f" stroke="black"/><rect x="48" y="20" width="4" height="20" fill="#333"/><path d="M 80 30 L 80 65" stroke="#ecf0f1" stroke-width="6"/><line x1="75" y1="65" x2="85" y2="65" stroke="#f1c40f" stroke-width="6"/></svg>`,
    musketeer: (c) => `<svg viewBox="0 0 100 100"><rect x="38" y="55" width="24" height="30" fill="${c}" stroke="black"/><circle cx="50" cy="35" r="14" fill="#ffccaa"/><path d="M 30 35 L 70 35 L 65 15 L 35 15 Z" fill="#8e44ad" stroke="black"/><rect x="55" y="55" width="40" height="8" fill="#34495e" stroke="black"/><rect x="55" y="52" width="10" height="14" fill="#8d6e63"/></svg>`,
    giant: (c) => `<svg viewBox="0 0 100 100"><rect x="25" y="35" width="50" height="55" fill="#d35400" rx="10" stroke="black"/><rect x="30" y="40" width="40" height="20" fill="${c}"/><circle cx="50" cy="25" r="18" fill="#ffccaa" stroke="black"/><path d="M 35 25 Q 50 45 65 25" fill="#e67e22"/><circle cx="20" cy="65" r="12" fill="#ffccaa" stroke="black"/><circle cx="80" cy="65" r="12" fill="#ffccaa" stroke="black"/></svg>`,
    skeleton: (c) => `<svg viewBox="0 0 100 100"><circle cx="50" cy="30" r="14" fill="#eee" stroke="black" stroke-width="2"/><line x1="50" y1="44" x2="50" y2="75" stroke="#eee" stroke-width="5"/><line x1="30" y1="55" x2="70" y2="55" stroke="#eee" stroke-width="5"/><circle cx="45" cy="28" r="3" fill="black"/><circle cx="55" cy="28" r="3" fill="black"/><path d="M 70 45 L 80 25" stroke="#bdc3c7" stroke-width="3"/></svg>`,
    minion: (c) => `<svg viewBox="0 0 100 100"><circle cx="50" cy="40" r="20" fill="#3498db" stroke="black"/><path d="M 20 40 Q 10 10 40 30" fill="#ecf0f1" stroke="black"/><path d="M 80 40 Q 90 10 60 30" fill="#ecf0f1" stroke="black"/><circle cx="45" cy="35" r="5" fill="white"/><circle cx="55" cy="35" r="5" fill="white"/></svg>`,
    valkyrie: (c) => `<svg viewBox="0 0 100 100"><rect x="35" y="50" width="30" height="30" fill="${c}" stroke="black"/><circle cx="50" cy="35" r="15" fill="#ffccaa"/><path d="M 30 35 Q 50 10 70 35" fill="#e67e22" stroke="black"/><path d="M 70 50 L 90 30 L 90 70 Z" fill="#7f8c8d" stroke="black"/></svg>`,
    tower: (c) => `<svg viewBox="0 0 100 100"><rect x="25" y="30" width="50" height="60" fill="#95a5a6" stroke="black" stroke-width="2"/><path d="M 25 30 L 25 20 L 35 20 L 35 30 M 45 30 L 45 20 L 55 20 L 55 30 M 65 30 L 65 20 L 75 20 L 75 30" fill="#95a5a6" stroke="black"/><rect x="35" y="40" width="30" height="30" fill="${c}" stroke="black"/></svg>`,
    king: (c) => `<svg viewBox="0 0 100 100"><rect x="15" y="50" width="70" height="40" fill="#7f8c8d" stroke="black"/><rect x="35" y="20" width="30" height="30" fill="${c}" stroke="black"/><path d="M 35 20 L 35 5 L 45 15 L 50 0 L 55 15 L 65 5 L 65 20 Z" fill="#f1c40f" stroke="black"/></svg>`,
    arrows: (c) => `<svg viewBox="0 0 100 100"><path d="M30 70 L50 30 L70 70 M50 30 L50 90" stroke="#f39c12" stroke-width="6" fill="none"/><path d="M20 60 L40 20 L60 60" stroke="#f1c40f" stroke-width="4" fill="none" opacity="0.7"/><path d="M40 80 L60 40 L80 80" stroke="#f1c40f" stroke-width="4" fill="none" opacity="0.7"/></svg>`,
    fireball: (c) => `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" fill="#e67e22" stroke="#d35400" stroke-width="3"/><path d="M50 80 Q30 70 50 20 Q70 70 50 80" fill="#f1c40f"/></svg>`,
    rocket: (c) => `<svg viewBox="0 0 100 100"><path d="M35 80 L35 40 Q50 10 65 40 L65 80 Z" fill="#7f8c8d" stroke="black"/><circle cx="50" cy="50" r="10" fill="#3498db"/></svg>`
};

const CARDS = [
    { id: 'knight', name: 'Caballero', cost: 3, hp: 800, dmg: 80, speed: 0.5, type: 'melee', svg: 'knight' },
    { id: 'musketeer', name: 'Mosquetera', cost: 4, hp: 500, dmg: 100, speed: 0.5, type: 'range', range: 180, svg: 'musketeer' },
    { id: 'giant', name: 'Gigante', cost: 5, hp: 2200, dmg: 120, speed: 0.3, type: 'tank', svg: 'giant' },
    { id: 'skeleton', name: 'Esqueletos', cost: 1, hp: 100, dmg: 40, speed: 0.75, type: 'melee', count: 3, svg: 'skeleton' },
    { id: 'minion', name: 'Esbirro', cost: 2, hp: 160, dmg: 45, speed: 0.7, type: 'range', range: 100, svg: 'minion' },
    { id: 'valkyrie', name: 'Valquiria', cost: 4, hp: 1100, dmg: 150, speed: 0.5, type: 'melee', svg: 'valkyrie' },
    { id: 'arrows', name: 'Flechas', cost: 3, type: 'spell', dmg: 200, radius: 120, effectTime: 500, color: 'rgba(241, 196, 15, 0.5)', svg: 'arrows' },
    { id: 'fireball', name: 'Bola Fuego', cost: 4, type: 'spell', dmg: 500, radius: 80, effectTime: 800, color: 'rgba(230, 126, 34, 0.6)', svg: 'fireball' },
    { id: 'rocket', name: 'Cohete', cost: 6, type: 'spell', dmg: 1200, radius: 50, effectTime: 1500, color: 'rgba(52, 73, 94, 0.7)', svg: 'rocket' }
];

const game = {
    running: false, elixir: 5, enemyElixir: 5, entities: [], projectiles: [],
    selectedSlot: null, width: 0, height: 0, lastT: 0, timeLeft: 180, 
    hand: [], nextCardIndex: 0, 
    botDifficulty: 1, 

    init() { player.load(); },

    startBattle() {
        document.getElementById('main-menu').classList.remove('active');
        document.getElementById('game-screen').classList.add('active');
        document.getElementById('end-screen').style.display = 'none';

        const currentArena = player.getArena();
        const arenaEl = document.getElementById('arena');
        arenaEl.style.backgroundColor = currentArena.color;
        this.botDifficulty = currentArena.difficulty;
        document.getElementById('arena-name-ingame').innerText = currentArena.name;
        
        showToast("Arena: " + currentArena.name);

        const r = arenaEl.getBoundingClientRect();
        this.width = r.width; this.height = r.height;
        
        const bridgeY = this.height / 2;
        document.getElementById('zone-left').style.height = (bridgeY - 160) + 'px';
        document.getElementById('zone-right').style.height = (bridgeY - 160) + 'px';

        this.entities.forEach(e => e.el.remove()); this.entities = [];
        this.projectiles.forEach(p => p.el.remove()); this.projectiles = [];
        
        this.elixir = 5; this.enemyElixir = 5; this.timeLeft = 180; this.running = true;
        this.selectedSlot = null;
        
        let indices = CARDS.map((_, i) => i).sort(() => Math.random() - 0.5);
        this.hand = indices.slice(0, 4); this.nextCardIndex = indices[4]; 
        
        this.updateTimerDisplay();

        this.spawn('tower', 'player', this.width*0.2, this.height-70);
        this.spawn('tower', 'player', this.width*0.8, this.height-70);
        this.spawn('king', 'player', this.width*0.5, this.height-40);
        
        this.spawn('tower', 'enemy', this.width*0.2, 120);
        this.spawn('tower', 'enemy', this.width*0.8, 120);
        this.spawn('king', 'enemy', this.width*0.5, 85);

        this.renderDeck();
        requestAnimationFrame(t => this.loop(t));
        
        if(this.logicInt) clearInterval(this.logicInt);
        this.logicInt = setInterval(() => {
            if(!this.running) return;
            if(this.elixir < 10) this.elixir += 0.1;
            if(this.enemyElixir < 10) this.enemyElixir += (0.1 * this.botDifficulty);
        }, 300);

        if(this.timerInt) clearInterval(this.timerInt);
        this.timerInt = setInterval(() => {
            if(!this.running) return;
            this.timeLeft--;
            this.updateTimerDisplay();
            if(this.timeLeft <= 0) this.end(false);
            this.botAI();
        }, 1000);
    },

    updateTimerDisplay() {
        const m = Math.floor(this.timeLeft / 60); const s = this.timeLeft % 60;
        document.getElementById('timer-display').innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
        document.getElementById('next-card-indicator').innerText = "Sig: " + CARDS[this.nextCardIndex].name;
    },

    spawn(type, team, x, y, cardData = null) {
        let stats = cardData ? {...cardData} : (type==='king' ? {hp:3000, dmg:90, range:180, svg:'king'} : {hp:2000, dmg:80, range:180, svg:'tower'});
        if(!stats.maxHp) stats.maxHp = stats.hp;
        
        const el = document.createElement('div');
        el.className = `entity ${team} ${type==='king'||type==='tower' ? type : ''}`;
        el.innerHTML = `<div class="hp-bar"><div class="hp-fill"></div></div><div class="char-svg">${SVGS[stats.svg](team==='player' ? '#3b82f6' : '#ef4444')}</div>`;
        document.getElementById('arena').appendChild(el);

        const ent = { ...stats, team, x, y, el, lastAttack: 0, target: null, isTower: (type==='king'||type==='tower') };
        this.entities.push(ent);
        this.updatePos(ent);
    },

    castSpell(card, x, y) {
        const fly = document.createElement('div');
        fly.className = 'spell-fly';
        fly.innerHTML = SVGS[card.svg]('#fff');
        fly.style.left = (this.width/2) + 'px';
        fly.style.top = (this.height - 50) + 'px';
        document.getElementById('arena').appendChild(fly);

        setTimeout(() => { fly.style.left = x + 'px'; fly.style.top = y + 'px'; }, 10);
        setTimeout(() => {
            fly.remove();
            const boom = document.createElement('div');
            boom.className = 'spell-explosion';
            boom.style.width = (card.radius * 2) + 'px';
            boom.style.height = (card.radius * 2) + 'px';
            boom.style.background = card.color;
            boom.style.left = x + 'px'; boom.style.top = y + 'px';
            document.getElementById('arena').appendChild(boom);
            setTimeout(() => boom.remove(), 600);

            this.entities.forEach(e => {
                if (e.team === 'enemy') { 
                    const dist = Math.hypot(e.x - x, e.y - y);
                    if (dist < card.radius + 20) { 
                        e.hp -= card.dmg;
                        e.el.style.filter = "brightness(2) sepia(1) hue-rotate(-50deg) saturate(5)";
                        setTimeout(() => e.el.style.filter = "none", 200);
                    }
                }
            });
        }, card.effectTime);
    },

    loop(t) {
        if(!this.running) return;
        this.lastT = t;
        if(this.selectedSlot !== null) this.updateRedZones();

        this.entities.forEach(e => {
            if(e.hp <= 0) return;
            if(e.target && e.target.hp <= 0) e.target = null;

            if(!e.target) {
                let minD = Infinity;
                this.entities.forEach(o => {
                    if(e.team !== o.team && o.hp > 0) {
                        const d = Math.hypot(e.x - o.x, e.y - o.y);
                        if(d < (e.isTower ? 9999 : 200) && d < minD) { minD = d; e.target = o; }
                    }
                });
            }

            if(e.target) {
                const dist = Math.hypot(e.target.x - e.x, e.target.y - e.y);
                const range = e.range || 40;
                
                if(dist <= range) {
                    if(t - e.lastAttack > 1000) {
                        e.lastAttack = t;
                        if(e.type === 'range' || e.isTower) this.shoot(e, e.target);
                        else e.target.hp -= e.dmg;
                        e.el.style.transform = `translate(-50%,-50%) scale(1.1)`;
                        setTimeout(()=> this.updatePos(e), 100);
                    }
                } else if(!e.isTower) {
                    let moveX = e.target.x, moveY = e.target.y;
                    const riverY = this.height / 2;
                    const onOppositeSides = (e.y < riverY && e.target.y > riverY) || (e.y > riverY && e.target.y < riverY);
                    
                    if (onOppositeSides) {
                        const bl = this.width * 0.2, br = this.width * 0.8;
                        const distLeft = Math.abs(e.x - bl), distRight = Math.abs(e.x - br);
                        const targetBridgeX = (distLeft < distRight) ? bl : br;
                        const onBridge = Math.abs(e.x - targetBridgeX) < 25 && Math.abs(e.y - riverY) < 40;
                        if (!onBridge) { moveX = targetBridgeX; moveY = riverY; }
                    }
                    const angle = Math.atan2(moveY - e.y, moveX - e.x);
                    e.x += Math.cos(angle) * e.speed; e.y += Math.sin(angle) * e.speed;
                }
            } else if(!e.isTower) {
                const bridgeY = this.height / 2;
                const crossed = (e.team==='player' && e.y < bridgeY) || (e.team==='enemy' && e.y > bridgeY);
                let tx = e.x, ty = e.team==='player' ? 50 : this.height-50;
                if(!crossed) {
                    const bl = this.width*0.2, br = this.width*0.8;
                    tx = (Math.abs(e.x - bl) < Math.abs(e.x - br)) ? bl : br;
                    if(Math.abs(e.y - bridgeY) < 10 && Math.abs(e.x - tx) < 10) ty = e.team==='player'?bridgeY-20 : bridgeY+20;
                }
                const dx = tx - e.x, dy = ty - e.y, dist = Math.hypot(dx, dy);
                if(dist > 5) { e.x += (dx/dist)*e.speed; e.y += (dy/dist)*e.speed; }
            }
            this.updatePos(e);
            e.el.querySelector('.hp-fill').style.width = (e.hp/e.maxHp*100)+'%';
        });

        this.projectiles.forEach((p, i) => {
            const dx = p.target.x - p.x, dy = p.target.y - p.y, d = Math.hypot(dx, dy);
            if(d < 10 || p.target.hp <= 0) {
                if(p.target.hp > 0) p.target.hp -= p.dmg;
                p.el.remove(); this.projectiles.splice(i, 1);
            } else {
                p.x += (dx/d)*8; p.y += (dy/d)*8;
                p.el.style.left = p.x+'px'; p.el.style.top = p.y+'px';
            }
        });

        this.entities = this.entities.filter(e => {
            if(e.hp <= 0) { 
                e.el.remove(); 
                if(e.svg==='king') this.end(e.team!=='player'); 
                return false; 
            }
            return true;
        });
        
        this.updateUI(); 
        requestAnimationFrame(tx => this.loop(tx));
    },

    updatePos(e) { e.el.style.left = e.x+'px'; e.el.style.top = e.y+'px'; e.el.style.zIndex = Math.floor(e.y); e.el.style.transform = 'translate(-50%,-50%)'; },
    
    shoot(src, tgt) {
        const p = document.createElement('div'); p.className = 'projectile';
        document.getElementById('arena').appendChild(p);
        this.projectiles.push({x:src.x, y:src.y, target:tgt, dmg:src.dmg, el:p});
    },

    renderDeck() {
        const d = document.getElementById('deck'); d.innerHTML = '';
        this.hand.forEach((cardIdx, slotIdx) => {
            const c = CARDS[cardIdx];
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<div class="card-cost">${c.cost}</div><div class="card-icon">${SVGS[c.svg]('#333')}</div><div class="card-name">${c.name}</div>`;
            card.onclick = (e) => { e.stopPropagation(); this.selectCard(slotIdx); };
            d.appendChild(card);
        });
    },

    selectCard(slotIdx) {
        this.selectedSlot = (this.selectedSlot === slotIdx) ? null : slotIdx;
        this.updateUI();
        this.updateRedZones();
    },

    updateRedZones() {
        const zoneKing = document.getElementById('zone-king');
        const zoneLeft = document.getElementById('zone-left');
        const zoneRight = document.getElementById('zone-right');

        if (this.selectedSlot === null) {
            zoneKing.style.display = 'none'; zoneLeft.style.display = 'none'; zoneRight.style.display = 'none';
            return;
        }

        const cardIdx = this.hand[this.selectedSlot];
        const card = CARDS[cardIdx];
        if (card.type === 'spell') {
            zoneKing.style.display = 'none'; zoneLeft.style.display = 'none'; zoneRight.style.display = 'none';
            return;
        }

        zoneKing.style.display = 'block';
        const enemyLeft = this.entities.find(ent => ent.team === 'enemy' && ent.svg === 'tower' && ent.x < this.width/2);
        const enemyRight = this.entities.find(ent => ent.team === 'enemy' && ent.svg === 'tower' && ent.x > this.width/2);
        zoneLeft.style.display = enemyLeft ? 'block' : 'none';
        zoneRight.style.display = enemyRight ? 'block' : 'none';
    },

    updateUI() {
        document.getElementById('elixir-num').innerText = Math.floor(this.elixir);
        document.getElementById('elixir-fill').style.width = (this.elixir*10)+'%';
        const cardEls = document.querySelectorAll('.card');
        this.hand.forEach((cardIdx, i) => {
            const c = CARDS[cardIdx];
            const el = cardEls[i];
            if(el) {
                el.classList.toggle('selected', i === this.selectedSlot);
                el.classList.toggle('disabled', this.elixir < c.cost);
            }
        });
        document.getElementById('next-card-indicator').innerText = "Sig: " + CARDS[this.nextCardIndex].name;
    },

    botAI() {
        if(this.enemyElixir > 6 && Math.random() > 0.6) {
            const c = CARDS[Math.floor(Math.random()*CARDS.length)];
            if(c.type === 'spell') return; 
            if(this.enemyElixir >= c.cost) {
                this.enemyElixir -= c.cost;
                const isLeft = Math.random() > 0.5;
                const baseX = isLeft ? this.width*0.25 : this.width*0.75;
                let spawnY = 120;
                const playerLeftTower = this.entities.find(e => e.team === 'player' && e.svg === 'tower' && e.x < this.width/2);
                const playerRightTower = this.entities.find(e => e.team === 'player' && e.svg === 'tower' && e.x > this.width/2);
                
                if(isLeft && !playerLeftTower) spawnY = 120 + Math.random() * (this.height - 300); 
                else if(!isLeft && !playerRightTower) spawnY = 120 + Math.random() * (this.height - 300);
                const count = c.count || 1;
                for(let i=0; i<count; i++) this.spawn(c.id, 'enemy', baseX + (i*10), spawnY, c);
            }
        }
    },

    end(win) {
        this.running = false; 
        clearInterval(this.logicInt); 
        clearInterval(this.timerInt);
        
        let trophyChange = 0;
        let title = "TIEMPO AGOTADO";

        if (this.timeLeft > 0) { 
            if (win) {
                title = "¬°VICTORIA!";
                trophyChange = 30;
                player.coins += 20; 
            } else {
                title = "DERROTA";
                trophyChange = -20;
            }
        } else {
            title = "EMPATE";
            trophyChange = 0;
        }

        player.trophies += trophyChange;
        if(player.trophies < 0) player.trophies = 0;
        player.save(); 

        const endScreen = document.getElementById('end-screen');
        const titleEl = document.getElementById('end-title');
        const trophyEl = document.getElementById('end-trophies');
        
        endScreen.style.display = 'flex';
        titleEl.innerText = title;
        titleEl.style.color = win ? '#2ecc71' : (trophyChange < 0 ? '#e74c3c' : '#fff');
        
        const sign = trophyChange >= 0 ? '+' : '';
        trophyEl.innerText = `${sign}${trophyChange} üèÜ`;
    },

    returnToMenu() {
        document.getElementById('end-screen').style.display = 'none';
        document.getElementById('game-screen').classList.remove('active');
        document.getElementById('main-menu').classList.add('active');
        player.updateMenuUI();
    }
};

let toastTimeout;
function showToast(msg) {
    const t = document.getElementById('toast-msg');
    t.innerText = msg; t.classList.add('show');
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => { t.classList.remove('show'); }, 1500);
}

function handleTap(e) {
    if(!game.running || game.selectedSlot === null) return;
    const r = document.getElementById('arena').getBoundingClientRect();
    const x = e.clientX - r.left;
    const y = e.clientY - r.top;

    const cardIdx = game.hand[game.selectedSlot];
    const c = CARDS[cardIdx];

    let allowed = false;
    if (c.type === 'spell') allowed = true;
    else {
        const bridgeY = game.height / 2;
        if (y > bridgeY) allowed = true;
        else {
            const enemyLeft = game.entities.find(ent => ent.team === 'enemy' && ent.svg === 'tower' && ent.x < game.width/2);
            const enemyRight = game.entities.find(ent => ent.team === 'enemy' && ent.svg === 'tower' && ent.x > game.width/2);
            if (y > 160) {
                if (x < game.width/2 && !enemyLeft) allowed = true;
                if (x > game.width/2 && !enemyRight) allowed = true;
            }
        }
    }

    if(!allowed) { showToast("¬°NO PUEDES PONERLO AQU√ç!"); return; }
    
    if(game.elixir >= c.cost) {
        game.elixir -= c.cost;
        if (c.type === 'spell') game.castSpell(c, x, y);
        else {
            const count = c.count || 1;
            for(let i=0; i<count; i++) game.spawn(c.id, 'player', x + (i*10), y, c);
        }
        
        game.hand[game.selectedSlot] = game.nextCardIndex;
        let newNext;
        do { newNext = Math.floor(Math.random() * CARDS.length); } while (game.hand.includes(newNext));
        game.nextCardIndex = newNext;

        game.selectedSlot = null;
        game.renderDeck();
        game.updateUI();
        game.updateRedZones(); 
    } else {
        showToast("¬°FALTA ELIXIR!");
    }
}

game.init();
</script>
</body>
</html>
